<!DOCTYPE html>
<html>
   <head>
<!-- Jquery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      <script type ="text/javascript">
	
	$(document).ready(function(){
		waitForLogin();
		populateRooms();
	});
	var nickname = "Guest";
	var currentRoom = "General";
	var roomCreator = "Guest";
      var socketio = io.connect();
      socketio.on("message_to_client",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("chatlog").appendChild(document.createElement("hr"));
         document.getElementById("chatlog").appendChild(document.createTextNode(data['from'] + ": " + data['message']));
      });
      socketio.on("validate_nickname_to_client",function(data) {
		nickname = data['nickname'];
		currentRoom = data['inRoom'];
		roomCreator = data['creator'];
		$("#message_input").show();
		$("#sendButton").show();
		document.getElementById("crntRoom").innerHTML = currentRoom;
		var allUsers = "";
		for(var i = 0; i < data['users'].length; i++){
			allUsers += "<option>"+data['users'][i] + "</option>";
		}
		document.getElementById("RoomUsers").innerHTML = allUsers;
		$("#RoomUsers").show();
		if(nickname===roomCreator){
			$("#ban").show();
			$("#kick").show();
		}
		else{
			$("#ban").hide();
			$("#kick").hide();
		}
      });
      socketio.on("new_user_joined",function(data) {
		var allUsers = "";
		for(var i = 0; i < data['users'].length; i++){
			allUsers += "<option>"+data['users'][i] + "</option>";
		}
		document.getElementById("RoomUsers").innerHTML = allUsers;
      });
      socketio.on("return_rooms_to_client",function(data) {
		var numRooms = data['index'];
		var rooms = "";
		for(var i = 0; i < numRooms; i++){
			rooms += "<option>" + data['allRooms'][i] + "</option>";
		}
		document.getElementById("availableRooms").innerHTML = rooms;
      });
 
      function sendMessage(){
         var msg = document.getElementById("message_input").value;
         socketio.emit("message_to_server", {message:msg, toRoom:currentRoom, nickname:nickname});
      }

      function PMMessage(){
         var msg = document.getElementById("private_message_input").value;
	var usr = document.getElementById("RoomUsers").value;
         socketio.emit("private_message_to_server", {message:msg, toRoom:currentRoom, toUser:usr, nickname:nickname});
      }
	
	function waitForLogin(){
	//hide the ability to send messages until user has logged in.
		$("#message_input").hide();
		$("#sendButton").hide();
		$("#RoomUsers").hide();
		$("#ban").hide();
		$("#kick").hide();
	}

	function removePosts(){
		var posts = document.getElementById("chatlog");
		children = posts.childNodes;	
		while (children.length > 0){
			posts.removeChild(posts.lastChild);
			children = posts.childNodes;
		}
	}

	function login(){
	//log the user into the selected room.
		var name = document.getElementById("nickname").value;
		var joinRoom = document.getElementById("availableRooms").value;
		var pass = document.getElementById("pass").value;
		var usr = nickname;
		socketio.emit("nickname_to_server", {nickname:name, room:joinRoom, password:pass, crntUser:usr, crntRoom:currentRoom});	
	} 

	function populateRooms(){
	//fill the available rooms selector with all possible rooms
		socketio.emit("get_rooms_on_server");
	}

	function kick(){
		var name = document.getElementById("RoomUsers").value;
		socketio.emit("kick_user_on_server", {kickedUser:name, crntRoom:currentRoom});	
	}

	function ban(){
		var name = document.getElementById("RoomUsers").value;
		socketio.emit("ban_user_on_server", {bannedUser:name, kickedUser:name, crntRoom:currentRoom});	
	}

	function createNewRoom(){
	//make a new room with the user's input if that name is not already taken and add to the available rooms list
	var room_name = document.getElementById("createNewRoom").value;
	var leavingRoom = currentRoom;
	currentRoom=room_name;
	var room_pass = document.getElementById("newPass").value;
	socketio.emit("add_room_on_server", {creator:nickname, roomName: room_name, roomPass: room_pass});
	var name = document.getElementById("nickname").value;
	socketio.emit("nickname_to_server", {nickname:name, room:room_name, password:room_pass, crntUser:nickname, crntRoom:leavingRoom});	
	removePosts();
	//$("#crntRoom").innerHTML = room_name;
	populateRooms(); 		
	document.getElementById("crntRoom").innerHTML = room_name;
	}
      </script>
   </head>
   <body>
	<h1 id="crntRoom"> </h1>
	<label id="loginText">Nickname: </label> <input type="text" id="nickname"/>
	<select id="availableRooms">
	</select>
	<label id="passText">Password: </label> <input type="password" id="pass"/>
	<button onclick="login()" id="loginButton"> Join</button>
	<label id="newRoom">Create New Room: </label> <input type="text" id="createNewRoom"/>
	<label id="newPassText">Password (Leave blank for public room): </label> <input type="password" id="newPass"/>
	<button onclick="createNewRoom()" id="create"> Create</button>
      <input type=text" id="message_input"/>
      <button onclick="sendMessage()" id="sendButton">send</button>
	<select id="RoomUsers">
	</select>
      <input type=text" id="private_message_input"/>
      <button onclick="PMMessage()" id="PMButton">PM</button>
      <button onclick="kick()" id="kick">Kick</button>
      <button onclick="ban()" id="ban">Ban</button>
      <div id="chatlog"></div>
   </body>
</html>
