<!DOCTYPE html>
<html>
   <head>
<!-- Jquery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      <script type ="text/javascript">
	
	$(document).ready(function(){
		waitForLogin();
		populateRooms();
	});
	var nickname = "Guest";
	var currentRoom = "General";
      var socketio = io.connect();
      socketio.on("message_to_client",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("chatlog").appendChild(document.createElement("hr"));
         document.getElementById("chatlog").appendChild(document.createTextNode(data['message']));
      });
      socketio.on("validate_nickname_to_client",function(data) {
		nickname = data['nickname'];
		currentRoom = data['inRoom'];
		$("#message_input").show();
		$("#sendButton").show();
		document.getElementById("crntRoom").innerHTML = currentRoom;
		var allUsers = "";
		for(var i = 0; i < data['users'].length; i++){
			allUsers += "<option>"+data['users'][i] + "</option>";
		}
		document.getElementById("RoomUsers").innerHTML = allUsers;
		$("#RoomUsers").show();
      });
      socketio.on("return_rooms_to_client",function(data) {
		//TODO: remove all chiled nodes in available rooms
		var numRooms = data['index'];
		for(var i = 0; i < numRooms; i++){
			var opt = document.createElement("option");
			opt.class = "room";
			opt.value = data['allRooms'][i];
			opt.innerHTML = data['allRooms'][i];
			document.getElementById("availableRooms").appendChild(opt);
		}
      });
 
      function sendMessage(){
         var msg = document.getElementById("message_input").value;
         socketio.emit("message_to_server", {message:msg, toRoom:currentRoom});
      }
	
	function waitForLogin(){
	//hide the ability to send messages until user has logged in.
		$("#message_input").hide();
		$("#sendButton").hide();
		$("#RoomUsers").hide();
	}

	function removePosts(){
		var posts = document.getElementById("chatlog");
		children = posts.childNodes;	
		while (children.length > 0){
			posts.removeChild(posts.lastChild);
			children = posts.childNodes;
		}
	}

	function login(){
	//log the user into the selected room.
		var name = document.getElementById("nickname").value;
		var joinRoom = document.getElementById("availableRooms").value;
		var pass = document.getElementById("pass").value;
		socketio.emit("nickname_to_server", {nickname:name, room:joinRoom, password:pass});	
	} 

	function populateRooms(){
	//fill the available rooms selector with all possible rooms
		socketio.emit("get_rooms_on_server");
	}

	function createNewRoom(){
	//make a new room with the user's input if that name is not already taken and add to the available rooms list
	var room_name = document.getElementById("createNewRoom").value;
	alert(room_name);
	var room_pass = document.getElementById("newPass").value;
	socketio.emit("add_room_on_server", {creator:nickname, roomName: room_name, roomPass: room_pass});
	removePosts();
	//$("#crntRoom").innerHTML = room_name;
	populateRooms(); 		
	document.getElementById("crntRoom").innerHTML = room_name;
	}
      </script>
   </head>
   <body>
	<h1 id="crntRoom"> </h1>
	<label id="loginText">Nickname: </label> <input type="text" id="nickname"/>
	<select id="availableRooms">
	</select>
	<label id="passText">Password: </label> <input type="password" id="pass"/>
	<button onclick="login()" id="loginButton"> Join</button>
	<label id="newRoom">Create New Room: </label> <input type="text" id="createNewRoom"/>
	<label id="newPassText">Password (Leave blank for public room): </label> <input type="password" id="newPass"/>
	<button onclick="createNewRoom()" id="create"> Create</button>
	<select id="RoomUsers">
	</select>
      <input type=text" id="message_input"/>
      <button onclick="sendMessage()" id="sendButton">send</button>
      <div id="chatlog"></div>
   </body>
</html>
